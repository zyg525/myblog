(window.webpackJsonp=window.webpackJsonp||[]).push([[123],{467:function(t,s,a){"use strict";a.r(s);var n=a(4),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("学习不走弯路，"),s("a",{attrs:{href:"#%E5%85%AC%E4%BC%97%E5%8F%B7"}},[t._v("关注公众号")]),t._v(" 回复「学习路线」，获取mall项目专属学习路线！")]),t._v(" "),s("h1",{attrs:{id:"mall整合springtask实现定时任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mall整合springtask实现定时任务"}},[t._v("#")]),t._v(" mall整合SpringTask实现定时任务")]),t._v(" "),s("blockquote",[s("p",[t._v("本文主要讲解mall整合SpringTask的过程，以批量修改超时订单为例。")])]),t._v(" "),s("h2",{attrs:{id:"项目使用框架介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#项目使用框架介绍"}},[t._v("#")]),t._v(" 项目使用框架介绍")]),t._v(" "),s("h3",{attrs:{id:"springtask"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#springtask"}},[t._v("#")]),t._v(" SpringTask")]),t._v(" "),s("blockquote",[s("p",[t._v("SpringTask是Spring自主研发的轻量级定时任务工具，相比于Quartz更加简单方便，且不需要引入其他依赖即可使用。")])]),t._v(" "),s("h3",{attrs:{id:"cron表达式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cron表达式"}},[t._v("#")]),t._v(" Cron表达式")]),t._v(" "),s("blockquote",[s("p",[t._v("Cron表达式是一个字符串，包括6~7个时间元素，在SpringTask中可以用于指定任务的执行时间。")])]),t._v(" "),s("h4",{attrs:{id:"cron的语法格式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cron的语法格式"}},[t._v("#")]),t._v(" Cron的语法格式")]),t._v(" "),s("p",[t._v("Seconds Minutes Hours DayofMonth Month DayofWeek")]),t._v(" "),s("h4",{attrs:{id:"cron格式中每个时间元素的说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cron格式中每个时间元素的说明"}},[t._v("#")]),t._v(" Cron格式中每个时间元素的说明")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间元素")]),t._v(" "),s("th",[t._v("可出现的字符")]),t._v(" "),s("th",[t._v("有效数值范围")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("Seconds")]),t._v(" "),s("td",[t._v(", - * /")]),t._v(" "),s("td",[t._v("0-59")])]),t._v(" "),s("tr",[s("td",[t._v("Minutes")]),t._v(" "),s("td",[t._v(", - * /")]),t._v(" "),s("td",[t._v("0-59")])]),t._v(" "),s("tr",[s("td",[t._v("Hours")]),t._v(" "),s("td",[t._v(", - * /")]),t._v(" "),s("td",[t._v("0-23")])]),t._v(" "),s("tr",[s("td",[t._v("DayofMonth")]),t._v(" "),s("td",[t._v(", - * / ? L W")]),t._v(" "),s("td",[t._v("0-31")])]),t._v(" "),s("tr",[s("td",[t._v("Month")]),t._v(" "),s("td",[t._v(", - * /")]),t._v(" "),s("td",[t._v("1-12")])]),t._v(" "),s("tr",[s("td",[t._v("DayofWeek")]),t._v(" "),s("td",[t._v(", - * / ? L #")]),t._v(" "),s("td",[t._v("1-7或SUN-SAT")])])])]),t._v(" "),s("h4",{attrs:{id:"cron格式中特殊字符说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cron格式中特殊字符说明"}},[t._v("#")]),t._v(" Cron格式中特殊字符说明")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("字符")]),t._v(" "),s("th",[t._v("作用")]),t._v(" "),s("th",[t._v("举例")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v(",")]),t._v(" "),s("td",[t._v("列出枚举值")]),t._v(" "),s("td",[t._v("在Minutes域使用5,10，表示在5分和10分各触发一次")])]),t._v(" "),s("tr",[s("td",[t._v("-")]),t._v(" "),s("td",[t._v("表示触发范围")]),t._v(" "),s("td",[t._v("在Minutes域使用5-10，表示从5分到10分钟每分钟触发一次")])]),t._v(" "),s("tr",[s("td",[t._v("*")]),t._v(" "),s("td",[t._v("匹配任意值")]),t._v(" "),s("td",[t._v("在Minutes域使用*, 表示每分钟都会触发一次")])]),t._v(" "),s("tr",[s("td",[t._v("/")]),t._v(" "),s("td",[t._v("起始时间开始触发，每隔固定时间触发一次")]),t._v(" "),s("td",[t._v("在Minutes域使用5/10,表示5分时触发一次，每10分钟再触发一次")])]),t._v(" "),s("tr",[s("td",[t._v("?")]),t._v(" "),s("td",[t._v("在DayofMonth和DayofWeek中，用于匹配任意值")]),t._v(" "),s("td",[t._v("在DayofMonth域使用?,表示每天都触发一次")])]),t._v(" "),s("tr",[s("td",[t._v("#")]),t._v(" "),s("td",[t._v("在DayofMonth中，确定第几个星期几")]),t._v(" "),s("td",[t._v("1#3表示第三个星期日")])]),t._v(" "),s("tr",[s("td",[t._v("L")]),t._v(" "),s("td",[t._v("表示最后")]),t._v(" "),s("td",[t._v("在DayofWeek中使用5L,表示在最后一个星期四触发")])]),t._v(" "),s("tr",[s("td",[t._v("W")]),t._v(" "),s("td",[t._v("表示有效工作日(周一到周五)")]),t._v(" "),s("td",[t._v("在DayofMonth使用5W，如果5日是星期六，则将在最近的工作日4日触发一次")])])])]),t._v(" "),s("h2",{attrs:{id:"业务场景说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#业务场景说明"}},[t._v("#")]),t._v(" 业务场景说明")]),t._v(" "),s("ul",[s("li",[t._v("用户对某商品进行下单操作；")]),t._v(" "),s("li",[t._v("系统需要根据用户购买的商品信息生成订单并锁定商品的库存；")]),t._v(" "),s("li",[t._v("系统设置了60分钟用户不付款就会取消订单；")]),t._v(" "),s("li",[t._v("开启一个定时任务，每隔10分钟检查下，如果有超时还未付款的订单，就取消订单并取消锁定的商品库存。")])]),t._v(" "),s("h2",{attrs:{id:"整合springtask"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#整合springtask"}},[t._v("#")]),t._v(" 整合SpringTask")]),t._v(" "),s("blockquote",[s("p",[t._v("由于SpringTask已经存在于Spring框架中，所以无需添加依赖。")])]),t._v(" "),s("h3",{attrs:{id:"添加springtask的配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加springtask的配置"}},[t._v("#")]),t._v(" 添加SpringTask的配置")]),t._v(" "),s("blockquote",[s("p",[t._v("只需要在配置类中添加一个@EnableScheduling注解即可开启SpringTask的定时任务能力。")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("macro"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tiny"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Configuration")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduling"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("EnableScheduling")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * 定时任务配置\n * Created by macro on 2019/4/8.\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@EnableScheduling")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SpringTaskConfig")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("h3",{attrs:{id:"添加ordertimeoutcanceltask来执行定时任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加ordertimeoutcanceltask来执行定时任务"}},[t._v("#")]),t._v(" 添加OrderTimeOutCancelTask来执行定时任务")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("macro"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tiny"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("component")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("slf4j"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Logger")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("slf4j"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LoggerFactory")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scheduling"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Scheduled")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stereotype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Created by macro on 2018/8/24.\n * 订单超时取消并解锁库存的定时器\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderTimeOutCancelTask")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Logger")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LOGGER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LoggerFactory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLogger")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderTimeOutCancelTask")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n     * cron表达式：Seconds Minutes Hours DayofMonth Month DayofWeek [Year]\n     * 每10分钟扫描一次，扫描设定超时时间之前下的订单，如果没支付则取消该订单\n     */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Scheduled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cron "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0 0/10 * ? * ?"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancelTimeOutOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// TODO: 2019/5/3 此处应调用取消订单的方法，具体查看mall项目源码")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LOGGER")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"取消订单，并根据sku编号释放锁定库存"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br")])]),s("h2",{attrs:{id:"项目源码地址"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#项目源码地址"}},[t._v("#")]),t._v(" 项目源码地址")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/macrozheng/mall-learning/tree/master/mall-tiny-05",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/macrozheng/mall-learning/tree/master/mall-tiny-05"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"公众号"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#公众号"}},[t._v("#")]),t._v(" 公众号")]),t._v(" "),s("p",[s("img",{attrs:{src:"http://macro-oss.oss-cn-shenzhen.aliyuncs.com/mall/banner/qrcode_for_macrozheng_258.jpg",alt:"公众号图片"}})])])}),[],!1,null,null,null);s.default=r.exports}}]);