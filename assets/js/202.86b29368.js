(window.webpackJsonp=window.webpackJsonp||[]).push([[202],{546:function(a,s,t){"use strict";t.r(s);var e=t(4),n=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("学习不走弯路，"),s("a",{attrs:{href:"#%E5%85%AC%E4%BC%97%E5%8F%B7"}},[a._v("关注公众号")]),a._v(" 回复「学习路线」，获取mall项目专属学习路线！")]),a._v(" "),s("h1",{attrs:{id:"你还在代码里做读写分离么-试试这个中间件吧"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#你还在代码里做读写分离么-试试这个中间件吧"}},[a._v("#")]),a._v(" 你还在代码里做读写分离么，试试这个中间件吧！")]),a._v(" "),s("blockquote",[s("p",[a._v("传统的MySql读写分离方案是通过在代码中根据SQL语句的类型动态切换数据源来实现的，那么有没有什么中间件可以自动实现读写分离呢？小米开源的数据库中间件Gaea就可以实现，接下来我们将详细讲解如何使用Gaea来实现MySql的读写分离。")])]),a._v(" "),s("h2",{attrs:{id:"gaea简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gaea简介"}},[a._v("#")]),a._v(" Gaea简介")]),a._v(" "),s("p",[a._v("Gaea是小米中国区电商研发部研发的基于MySql协议的数据库中间件，目前在小米商城大陆和海外得到广泛使用，包括订单、社区、活动等多个业务。Gaea支持分库分表、SQL路由、读写分离等基本特性，其中分库分表方案兼容了mycat和kingshard两个项目的路由方式。")]),a._v(" "),s("h2",{attrs:{id:"mysql主从复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从复制"}},[a._v("#")]),a._v(" MySql主从复制")]),a._v(" "),s("p",[a._v("使用Gaea需要依赖MySql的主从复制环境，关于MySql的主从复制可以参考："),s("a",{attrs:{href:"https://mp.weixin.qq.com/s/W9G9_yo46zlttNwnz0DuQQ",target:"_blank",rel:"noopener noreferrer"}},[a._v("MySql主从复制，从原理到实践！"),s("OutboundLink")],1)]),a._v(" "),s("h2",{attrs:{id:"直接在linux下安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#直接在linux下安装"}},[a._v("#")]),a._v(" 直接在Linux下安装")]),a._v(" "),s("blockquote",[s("p",[a._v("目前官方提供的是在Linux下直接安装的方式，我们先按此方法来安装Gaea。")])]),a._v(" "),s("h3",{attrs:{id:"安装go语言环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装go语言环境"}},[a._v("#")]),a._v(" 安装Go语言环境")]),a._v(" "),s("blockquote",[s("p",[a._v("由于Gaea是使用Go语言编写的，所以我们需要先安装Go语言的环境。")])]),a._v(" "),s("ul",[s("li",[a._v("安装Go语言环境，下载地址：https://golang.org/dl/")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_01.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("下载完成后解压到"),s("code",[a._v("/mydata")]),a._v("目录下；")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-zxvf")]),a._v(" go1.13.5.linux-amd64.tar.gz "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" /mydata/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("添加"),s("code",[a._v("/mydata/go/bin")]),a._v("目录到PATH变量中：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 编辑环境变量配置文件")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/profile\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在最后一行添加")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("GOROOT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("mydata/go\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s("span",{pre:!0,attrs:{class:"token environment constant"}},[a._v("PATH")])]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token environment constant"}},[a._v("$PATH")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$GOROOT")]),a._v("/bin\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 刷新配置文件")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("source")]),a._v(" /etc/profile\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("ul",[s("li",[a._v("查看版本号，测试是否安装成功：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("go version\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("返回以下信息表示Go语言环境已经安装成功了：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("go version go1.13.5 linux/amd64\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h3",{attrs:{id:"安装gaea"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装gaea"}},[a._v("#")]),a._v(" 安装Gaea")]),a._v(" "),s("blockquote",[s("p",[a._v("由于Gaea并没有提供安装包，所以我们需要自行编译源码获取可执行文件。")])]),a._v(" "),s("ul",[s("li",[s("p",[a._v("下载Gaea的源码，直接下载"),s("code",[a._v("zip")]),a._v("包即可，下载地址：https://github.com/XiaoMi/Gaea")])]),a._v(" "),s("li",[s("p",[a._v("将下载好的压缩包进行解压操作，这里我们解压到"),s("code",[a._v("/mydata/gaea/")]),a._v("目录下：")])])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("unzip")]),a._v(" Gaea-master.zip\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("进入"),s("code",[a._v("/mydata/gaea/")]),a._v("目录下，使用"),s("code",[a._v("make")]),a._v("命令对源码编译：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v(" build\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[s("p",[s("code",[a._v("注意")]),a._v("：由于网络问题，某些Go的依赖会下载不下来导致编译失败，多尝试几次即可成功；")])]),a._v(" "),s("li",[s("p",[a._v("编译完成后在"),s("code",[a._v("/mydata/gaea/bin")]),a._v("目录下会生成Gaea的执行文件"),s("code",[a._v("gaea")]),a._v("：")])])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_02.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("由于我们没有搭建"),s("code",[a._v("etcd")]),a._v("配置中心，所以需要修改本地配置文件"),s("code",[a._v("/mydata/gaea/etc/gaea.ini")]),a._v("，将配置类型改为"),s("code",[a._v("file")]),a._v("：")])]),a._v(" "),s("div",{staticClass:"language-ini line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("; 配置类型，目前支持file/etcd两种方式，file方式不支持热加载")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("config_type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("file")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("ul",[s("li",[a._v("添加namespace配置文件，用于配置我们的主从数据库信息，配置文件地址："),s("code",[a._v("/mydata/gaea/etc/file/namespace/mall_namespace_1.json")])])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_03.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("配置文件内容如下：")])]),a._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mall_namespace_1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"online"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"read_only"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"allowed_dbs"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"mall"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"slow_sql_time"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"1000"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"black_sql"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"allowed_ip"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token null keyword"}},[a._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"slices"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"slice-0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"user_name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"root"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"password"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"root"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"master"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"192.168.6.132:3307"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"slaves"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"192.168.6.132:3308"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"statistic_slaves"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token null keyword"}},[a._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"capacity"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("12")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"max_capacity"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("24")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"idle_timeout"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("60")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"shard_rules"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token null keyword"}},[a._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"users"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"user_name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"macro"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"password"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"123456"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"namespace"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mall_namespace_1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"rw_flag"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"rw_split"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"other_property"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"default_slice"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"slice-0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"global_sequences"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token null keyword"}},[a._v("null")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br"),s("span",{staticClass:"line-number"},[a._v("37")]),s("br"),s("span",{staticClass:"line-number"},[a._v("38")]),s("br"),s("span",{staticClass:"line-number"},[a._v("39")]),s("br")])]),s("h3",{attrs:{id:"namespace配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#namespace配置文件"}},[a._v("#")]),a._v(" namespace配置文件")]),a._v(" "),s("blockquote",[s("p",[a._v("namespace的配置格式为json，包含分表、非分表、实例等配置信息，都可在运行时改变。")])]),a._v(" "),s("ul",[s("li",[s("p",[a._v("整体配置说明：")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("字段名称")]),a._v(" "),s("th",[a._v("字段类型")]),a._v(" "),s("th",[a._v("字段含义")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("name")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("namespace名称")])]),a._v(" "),s("tr",[s("td",[a._v("online")]),a._v(" "),s("td",[a._v("bool")]),a._v(" "),s("td",[a._v("是否在线，逻辑上下线使用")])]),a._v(" "),s("tr",[s("td",[a._v("read_only")]),a._v(" "),s("td",[a._v("bool")]),a._v(" "),s("td",[a._v("是否只读，namespace级别")])]),a._v(" "),s("tr",[s("td",[a._v("allowed_dbs")]),a._v(" "),s("td",[a._v("map")]),a._v(" "),s("td",[a._v("允许通过代理访问的数据库")])]),a._v(" "),s("tr",[s("td",[a._v("default_phy_dbs")]),a._v(" "),s("td",[a._v("map")]),a._v(" "),s("td",[a._v("默认数据库名, 与allowed_dbs一一对应")])]),a._v(" "),s("tr",[s("td",[a._v("slow_sql_time")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("慢sql时间，单位ms")])]),a._v(" "),s("tr",[s("td",[a._v("black_sql")]),a._v(" "),s("td",[a._v("string数组")]),a._v(" "),s("td",[a._v("黑名单sql")])]),a._v(" "),s("tr",[s("td",[a._v("allowed_ip")]),a._v(" "),s("td",[a._v("string数组")]),a._v(" "),s("td",[a._v("白名单IP")])]),a._v(" "),s("tr",[s("td",[a._v("slices")]),a._v(" "),s("td",[a._v("map数组")]),a._v(" "),s("td",[a._v("一主多从的物理实例，slice里map的具体字段可参照slice配置")])]),a._v(" "),s("tr",[s("td",[a._v("shard_rules")]),a._v(" "),s("td",[a._v("map数组")]),a._v(" "),s("td",[a._v("分库、分表、特殊表的配置内容，具体字段可参照shard配置")])]),a._v(" "),s("tr",[s("td",[a._v("users")]),a._v(" "),s("td",[a._v("map数组")]),a._v(" "),s("td",[a._v("应用端连接gaea所需要的用户配置，具体字段可参照users配置")])])])])]),a._v(" "),s("li",[s("p",[a._v("slice配置：")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("字段名称")]),a._v(" "),s("th",[a._v("字段类型")]),a._v(" "),s("th",[a._v("字段含义")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("name")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("分片名称，自动、有序生成")])]),a._v(" "),s("tr",[s("td",[a._v("user_name")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("数据库用户名")])]),a._v(" "),s("tr",[s("td",[a._v("password")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("数据库密码")])]),a._v(" "),s("tr",[s("td",[a._v("master")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("主实例地址")])]),a._v(" "),s("tr",[s("td",[a._v("slaves")]),a._v(" "),s("td",[a._v("string数组")]),a._v(" "),s("td",[a._v("从数据库地址，可以配置多个")])]),a._v(" "),s("tr",[s("td",[a._v("statistic_slaves")]),a._v(" "),s("td",[a._v("string数组")]),a._v(" "),s("td",[a._v("统计型从实例地址列表")])]),a._v(" "),s("tr",[s("td",[a._v("capacity")]),a._v(" "),s("td",[a._v("int")]),a._v(" "),s("td",[a._v("gaea_proxy与每个实例的连接池大小")])]),a._v(" "),s("tr",[s("td",[a._v("max_capacity")]),a._v(" "),s("td",[a._v("int")]),a._v(" "),s("td",[a._v("gaea_proxy与每个实例的连接池最大大小")])]),a._v(" "),s("tr",[s("td",[a._v("idle_timeout")]),a._v(" "),s("td",[a._v("int")]),a._v(" "),s("td",[a._v("gaea_proxy与后端mysql空闲连接存活时间，单位:秒")])])])])]),a._v(" "),s("li",[s("p",[a._v("users配置：")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("字段名称")]),a._v(" "),s("th",[a._v("字段类型")]),a._v(" "),s("th",[a._v("字段含义")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("user_name")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("数据库代理用户名，客户端通过该用户名访问")])]),a._v(" "),s("tr",[s("td",[a._v("password")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("数据库代理密码，客户端通过该用户名访问")])]),a._v(" "),s("tr",[s("td",[a._v("namespace")]),a._v(" "),s("td",[a._v("string")]),a._v(" "),s("td",[a._v("对应的命名空间")])]),a._v(" "),s("tr",[s("td",[a._v("rw_flag")]),a._v(" "),s("td",[a._v("int")]),a._v(" "),s("td",[a._v("读写标识, 只读=1, 读写=2")])]),a._v(" "),s("tr",[s("td",[a._v("rw_split")]),a._v(" "),s("td",[a._v("int")]),a._v(" "),s("td",[a._v("是否读写分离, 非读写分离=0, 读写分离=1")])]),a._v(" "),s("tr",[s("td",[a._v("other_property")]),a._v(" "),s("td",[a._v("int")]),a._v(" "),s("td",[a._v("目前用来标识是否走统计从实例, 普通用户=0, 统计用户=1")])])])])])]),a._v(" "),s("h2",{attrs:{id:"在docker容器中运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在docker容器中运行"}},[a._v("#")]),a._v(" 在Docker容器中运行")]),a._v(" "),s("blockquote",[s("p",[a._v("由于官方只提供了Linux下直接安装运行的方式，这里我们提供另一种运行方式，在Docker容器中作为服务运行。")])]),a._v(" "),s("h3",{attrs:{id:"打包成docker镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#打包成docker镜像"}},[a._v("#")]),a._v(" 打包成Docker镜像")]),a._v(" "),s("blockquote",[s("p",[a._v("Docker Hub 中并没有打包好的Gaea镜像，我们需要自行构建一个，下面详细介绍下如何构建Gaea的Docker镜像。")])]),a._v(" "),s("ul",[s("li",[a._v("这里我们使用Dockerfile构建Docker镜像，Dockerfile中的内容如下：")])]),a._v(" "),s("div",{staticClass:"language-dockerfile line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 该镜像需要依赖的基础镜像")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" golang:latest")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将当前目录下的gaea源码包复制到docker容器的/go/Gaea-master目录下，对于.tar.gz文件会自动解压")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ADD")]),a._v(" Gaea-master.tar.gz /go/Gaea-master")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将解压后的源码移动到/go/gaea目录中去")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("RUN")]),a._v(" bash -c "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'mv /go/Gaea-master/Gaea-master /go/gaea'")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 进入/go/gaea目录")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("WORKDIR")]),a._v(" /go/gaea")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将gaea源码进行打包编译")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("RUN")]),a._v(" bash -c "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'make build'")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 声明服务运行在13306端口")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("EXPOSE")]),a._v(" 13306")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 指定docker容器启动时执行的命令")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ENTRYPOINT")]),a._v(" ["),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/go/gaea/bin/gaea"')]),a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 指定维护者的名字")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("MAINTAINER")]),a._v(" macrozheng")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br")])]),s("ul",[s("li",[a._v("在此之前我们需要把Gaea的源码压缩包转换为"),s("code",[a._v(".tar.gz")]),a._v("格式方便在Docker容器中的解压，可以使用"),s("code",[a._v("压缩软件")]),a._v("来实现：")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_04.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("之后使用Docker命令构建Gaea的Docker镜像：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" gaea:1.0.2 "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("构建成功控制台输出：")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_12.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("将本地安装的Gaea配置文件复制到"),s("code",[a._v("/mydata/gaea-docker/etc/")]),a._v("目录下：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" /mydata/gaea/etc/ /mydata/gaea-docker/etc/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("使用Docker命令启动Gaea容器：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("13306")]),a._v(":13306 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" gaea "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /mydata/gaea-docker/etc:/go/gaea/etc "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" gaea:1.0.2\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("h2",{attrs:{id:"测试读写分离"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试读写分离"}},[a._v("#")]),a._v(" 测试读写分离")]),a._v(" "),s("blockquote",[s("p",[a._v("测试思路：首先我们关闭从实例的主从复制，然后通过Gaea代理来操作数据库，插入一条数据，如果主实例中有这条数据而从实例中没有，说明写操作是走的主库。然后再通过Gaea代理查询该表数据，如果没有这条数据，表示读操作走的是从库，证明读写分离成功。")])]),a._v(" "),s("ul",[s("li",[a._v("通过Navicat连接到Gaea代理，注意此处账号密码为Gaea的namespace中配置的内容，端口为Gaea的服务端口；")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_05.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("通过Navicat分别连接到主库和从库，用于查看数据，此时建立了以下三个数据库连接；")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_06.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("通过"),s("code",[a._v("stop slave")]),a._v("命令关闭"),s("code",[a._v("mysql-slave")]),a._v("实例的主从复制功能：")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_07.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("通过Gaea代理在"),s("code",[a._v("test")]),a._v("表中插入一条数据：")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_08.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("在主库中查看"),s("code",[a._v("test")]),a._v("表的数据，发现已有该数据：")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_09.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("在从库中查看"),s("code",[a._v("test")]),a._v("表的数据，发现没有该数据，证明写操作走的是主库：")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_10.png",alt:""}})]),a._v(" "),s("ul",[s("li",[a._v("直接在代理中查看"),s("code",[a._v("test")]),a._v("表中的数据，发现没有该数据，证明读操作走的是从库。")])]),a._v(" "),s("p",[s("img",{attrs:{src:"/img/mall/gaea_use_11.png",alt:""}})]),a._v(" "),s("h2",{attrs:{id:"结合springboot使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#结合springboot使用"}},[a._v("#")]),a._v(" 结合SpringBoot使用")]),a._v(" "),s("p",[a._v("在我们的SpringBoot应用中，我们只需要把Gaea的代理服务直接当做数据库服务来使用就可以实现读写分离了。这样就不用在代码中添加任何读写分离逻辑了，是不是很方便！")]),a._v(" "),s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[a._v("#")]),a._v(" 参考资料")]),a._v(" "),s("p",[a._v("更多资料请参考官方文档：https://github.com/XiaoMi/Gaea")]),a._v(" "),s("h2",{attrs:{id:"公众号"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#公众号"}},[a._v("#")]),a._v(" 公众号")]),a._v(" "),s("p",[s("img",{attrs:{src:"http://macro-oss.oss-cn-shenzhen.aliyuncs.com/mall/banner/qrcode_for_macrozheng_258.jpg",alt:"公众号图片"}})])])}),[],!1,null,null,null);s.default=n.exports}}]);