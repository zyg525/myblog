(window.webpackJsonp=window.webpackJsonp||[]).push([[199],{543:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("学习不走弯路，"),a("a",{attrs:{href:"#%E5%85%AC%E4%BC%97%E5%8F%B7"}},[s._v("关注公众号")]),s._v(" 回复「学习路线」，获取mall项目专属学习路线！")]),s._v(" "),a("h1",{attrs:{id:"居然有人想白嫖我的日志-赶紧开启安全保护压压惊"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#居然有人想白嫖我的日志-赶紧开启安全保护压压惊"}},[s._v("#")]),s._v(" 居然有人想白嫖我的日志，赶紧开启安全保护压压惊！")]),s._v(" "),a("blockquote",[a("p",[s._v("在"),a("a",{attrs:{href:"https://mp.weixin.qq.com/s/8nUunL02Y5AfXTCscYg54w",target:"_blank",rel:"noopener noreferrer"}},[s._v("《你居然还去服务器上捞日志，搭个日志收集系统难道不香么！》"),a("OutboundLink")],1),s._v("一文中我们介绍过ELK日志收集系统的搭建，由于我们的Kibana没有任何安全保护机制，如果部署到公网上去的话，任何人都可以查看你的日志了。日志暴露在网络上可不是件好事情，今天教大家如何给Kibana设置登录认证来保护它。")])]),s._v(" "),a("h2",{attrs:{id:"实现原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现原理"}},[s._v("#")]),s._v(" 实现原理")]),s._v(" "),a("p",[s._v("由于Kibana的日志信息都存储在Elasticsearch中，所以只要给Elasticsearch开启"),a("code",[s._v("X-PACK")]),s._v("中的安全功能，并给预置的账号设置好密码即可。Elasticsearch设置好之后，就可以在Kibana中对用户、角色、权限进行管理了，本文使用的ELK组件版本均为"),a("code",[s._v("7.6.2")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"elasticsearch设置密码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch设置密码"}},[s._v("#")]),s._v(" Elasticsearch设置密码")]),s._v(" "),a("ul",[a("li",[s._v("修改Elasticsearch的配置文件并开启"),a("code",[s._v("X-PACK")]),s._v("中的安全功能，该配置文件在安装目录的"),a("code",[s._v("config")]),s._v("文件夹下面，例如"),a("code",[s._v("elasticsearch-7.6.2\\config\\elasticsearch.yml")]),s._v("；")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.cors.enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.cors.allow-origin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.cors.allow-headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Authorization\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("xpack.security.enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("xpack.security.transport.ssl.enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("启动Elasticsearch服务，启动命令在"),a("code",[s._v("bin")]),s._v("目录下，例如"),a("code",[s._v("elasticsearch-7.6.2\\bin\\elasticsearch.bat")]),s._v("；")])]),s._v(" "),a("li",[a("p",[s._v("在"),a("code",[s._v("bin")]),s._v("目录下使用如下命令"),a("code",[s._v("elasticsearch-setup-passwords interactive")]),s._v("修改预置账号的密码，期间需要设置多个账号密码，我都设置成了"),a("code",[s._v("123456")]),s._v("；")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/mall/elk_security_01.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("期间设置了好几个账号，我们先来了解下这些账号都有啥作用吧；")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("elastic：超级管理员账号\nkibana：Kibana访问专用账号\nlogstash_system：Logstash访问专用账号\nbeats_system：FileBeat访问专用账号\napm_system：APM系统专用账号\nremote_monitoring_user：远程监控账号\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("ul",[a("li",[s._v("接下来我们需要在Kibana的配置文件中添加可以访问Elasticsearch的账号，该配置文件在安装目录的"),a("code",[s._v("config")]),s._v("文件夹下面，例如"),a("code",[s._v("kibana-7.6.2\\config\\kibana.yml")]),s._v("；")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kibana"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"123456"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("启动Kibana服务，启动命令在"),a("code",[s._v("bin")]),s._v("目录下，例如"),a("code",[s._v("kibana-7.6.2\\bin\\kibana.bat")]),s._v("；")])]),s._v(" "),a("li",[a("p",[s._v("当Kibana启动完成后，我们访问的时就需要登录认证了，使用超级管理员账号"),a("code",[s._v("elastic:123456")]),s._v("可以进行登录，访问地址：http://localhost:5601")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/mall/elk_security_02.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("登录成功后，在我们的"),a("code",[s._v("Management")]),s._v("选项中可以找到安全相关的配置，在此我们可以对用户、角色、权限进行设置。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/mall/elk_security_03.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"springboot安全访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#springboot安全访问"}},[s._v("#")]),s._v(" SpringBoot安全访问")]),s._v(" "),a("blockquote",[a("p",[s._v("由于Elasticsearch开启"),a("code",[s._v("X-PACK")]),s._v("中的安全功能，当我们的SpringBoot应用访问Elasticsearch时，也需要设置用户名和密码了！")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("我们可以直接在SpringBoot中设置超级管理员账号，但这不是个好办法，我们还是自己建个角色和账号吧！")])]),s._v(" "),a("li",[a("p",[s._v("首先在Kibana中创建一个应用访问专用的角色"),a("code",[s._v("app_user")]),s._v("；")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/mall/elk_security_04.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("创建一个用户并配置好该角色，账号密码为"),a("code",[s._v("app:123456")]),s._v("；")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/mall/elk_security_05.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("修改SpringBoot应用的配置文件"),a("code",[s._v("application.yml")]),s._v("，配置好账号密码即可正常访问了！")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("uris")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"logstash安全访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#logstash安全访问"}},[s._v("#")]),s._v(" Logstash安全访问")]),s._v(" "),a("blockquote",[a("p",[s._v("由于Elasticsearch开启"),a("code",[s._v("X-PACK")]),s._v("中的安全功能，向Elasticsearch输出日志的Logstash也需要设置用户名和密码了！")])]),s._v(" "),a("ul",[a("li",[s._v("首先修改我们原来的Logstash配置文件"),a("code",[s._v("logstash.conf")]),s._v("，在"),a("code",[s._v("output")]),s._v("节点下设置访问Elasticsearch的用户名和密码，直接使用我们创建的"),a("code",[s._v("app:123456")]),s._v("账号即可；")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('input {\n  tcp {\n    mode => "server"\n    host => "0.0.0.0"\n    port => 4560\n    codec => json_lines\n    type => "debug"\n  }\n  tcp {\n    mode => "server"\n    host => "0.0.0.0"\n    port => 4561\n    codec => json_lines\n    type => "error"\n  }\n  tcp {\n    mode => "server"\n    host => "0.0.0.0"\n    port => 4562\n    codec => json_lines\n    type => "business"\n  }\n  tcp {\n    mode => "server"\n    host => "0.0.0.0"\n    port => 4563\n    codec => json_lines\n    type => "record"\n  }\n}\nfilter{\n  if [type] == "record" {\n    mutate {\n      remove_field => "port"\n      remove_field => "host"\n      remove_field => "@version"\n    }\n    json {\n      source => "message"\n      remove_field => ["message"]\n    }\n  }\n}\noutput {\n  elasticsearch {\n    hosts => ["localhost:9200"]\n    action => "index"\n    codec => json\n    index => "mall-tiny-%{type}-%{+YYYY.MM.dd}"\n    template_name => "mall-tiny"\n    user => app\n    password => "123456"\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br")])]),a("ul",[a("li",[s._v("使用指定配置文件启动Logstash服务，启动命令在"),a("code",[s._v("bin")]),s._v("目录下，例如"),a("code",[s._v("logstash-7.6.2\\bin\\logstash.bat")]),s._v("；")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("logstash "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" logstash.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("接下来在Kibana中就可以查看到应用输出的日志了！")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/mall/elk_security_06.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"项目源码地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目源码地址"}},[s._v("#")]),s._v(" 项目源码地址")]),s._v(" "),a("p",[s._v("https://github.com/macrozheng/mall-learning/tree/master/mall-tiny-log")]),s._v(" "),a("h2",{attrs:{id:"公众号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#公众号"}},[s._v("#")]),s._v(" 公众号")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://macro-oss.oss-cn-shenzhen.aliyuncs.com/mall/banner/qrcode_for_macrozheng_258.jpg",alt:"公众号图片"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);